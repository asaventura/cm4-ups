/dts-v1/;
/plugin/;

/ {
    compatible = "brcm,bcm2711";

    /* Фрагмент для включения интерфейса DSI0 */
    fragment@0 {
        target = <&dsi0>;
        __overlay__ {
            #address-cells = <1>;
            #size-cells = <0>;
            status = "okay";

            port {
                dsi0_out: endpoint {
                    remote-endpoint = <&panel_in>;
                };
            };

            /* Описание самой панели */
            panel: panel@0 {
                compatible = "boe,tv101wum-ll2"; // Совместимость с драйвером в ядре
                reg = <0>;
                status = "okay";

                // Ссылки на узлы питания и подсветки
                power-supply = <&panel_power>;
                backlight = <&backlight>;

                // Указание GPIO для сброса дисплея (LCD_RST)
                // Подключен к GPIO17 (Pin 11), активный уровень - низкий
                reset-gpios = <&gpio 17 1>; // 1 = Active Low

                // Указание GPIO для сброса тач-панели (TP_RST)
                // Подключен к GPIO27 (Pin 13), активный уровень - низкий (стандартно)
                tp-reset-gpios = <&gpio 27 1>; // 1 = Active Low

                // Указание GPIO для прерывания от тач-панели (TP_INT)
                // Подключен к GPIO22 (Pin 15)
                tp-int-gpios = <&gpio 22 8>; // 8 = IRQ_TYPE_EDGE_FALLING

                port {
                    panel_in: endpoint {
                        remote-endpoint = <&dsi0_out>;
                    };
                };
            };
        };
    };

    /* Фрагмент для управления питанием панели */
    fragment@1 {
        target = <&gpio>;
        __overlay__ {
            panel_power_pins: panel_power_pins {
                brcm,pins = <23 24>; // GPIO23 (Pin 16), GPIO24 (Pin 18)
                brcm,function = <1>; // 1 = Output
            };
        };
    };

    fragment@2 {
        target-path = "/";
        __overlay__ {
            /* Фиктивный регулятор для управления питанием через GPIO */
            panel_power: panel_power_regulator {
                compatible = "regulator-fixed";
                regulator-name = "panel_power";
                // GPIO для EN+5V8 (GPIO23) и EN-5V8 (GPIO24)
                gpio = <&gpio 23 0>, <&gpio 24 0>; // 0 = Active High
                enable-active-high;
                // Задержка включения, если требуется по спецификации
                startup-delay-us = <5000>; [span_0](start_span)// 5 мс, t3 из спецификации[span_0](end_span)
            };
        };
    };

    /* Фрагмент для управления подсветкой */
    fragment@3 {
        target = <&gpio>;
        __overlay__ {
            backlight_pins: backlight_pins {
                brcm,pins = <13>; // GPIO13 (Pin 33) для BL_EN
                brcm,function = <1>; // 1 = Output
            };
        };
    };

    fragment@4 {
        target-path = "/";
        __overlay__ {
            backlight: backlight {
                compatible = "pwm-backlight";
                // BL_PWM подключен к GPIO18 (Pin 12), который является аппаратным PWM0
                pwms = <&pwm0 0 50000>; // PWM0, канал 0, период 50000 нс (частота 20 кГц)

                // BL_EN подключен к GPIO13 (Pin 33)
                enable-gpios = <&gpio 13 0>; [span_1](start_span)// 0 = Active High[span_1](end_span)

                brightness-levels = <0 4 8 16 32 64 128 255>;
                default-brightness-level = <6>;
                power-supply = <&panel_power>;
                status = "okay";
            };
        };
    };

    /* Включение PWM0 */
    fragment@5 {
        target = <&pwm0>;
        __overlay__ {
            status = "okay";
        };
    };
};
