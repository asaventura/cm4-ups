/dts-v1/;
/plugin/;

/ {
    compatible = "brcm,bcm2711";

    // --- Фрагменты для установки GPIO из config.txt ---
    fragment@0 {
        target = <&panel_power_p5v8>;
        __overlay__ { gpios = <&gpio 23 0>; }; // EN+5V8
    };
    fragment@1 {
        target = <&panel_power_n5v8>;
        __overlay__ { gpios = <&gpio 24 0>; }; // EN-5V8
    };
    fragment@2 {
        target = <&backlight_pwm>;
        __overlay__ { enable-gpios = <&gpio 13 0>; }; // BL_EN
    };
    fragment@3 {
        target = <&panel_dsi1>;
        __overlay__ { reset-gpios = <&gpio 17 1>; }; // LCD_RST
    };
    fragment@4 {
        target = <&touchscreen_i2c>;
        __overlay__ {
            interrupts = <22 2>;     // TP_INT
            reset-gpios = <&gpio 27 1>; // TP_RST
        };
    };

    // --- Описание дисплея на интерфейсе DSI1 ---
    fragment@5 {
        target = <&dsi1>; // ИЗМЕНЕНО: Цель - интерфейс DSI1
        __overlay__ {
            #address-cells = <1>;
            #size-cells = <0>;
            status = "okay";

            port {
                dsi1_out: endpoint {
                    remote-endpoint = <&panel_in_dsi1>;
                };
            };

            panel_dsi1: panel@0 {
                compatible = "boe,tv101wum-ll2";
                reg = <0>;
                status = "okay";

                // ИЗМЕНЕНО: Указываем два независимых источника питания
                power-supply = <&panel_power_p5v8>, <&panel_power_n5v8>;
                backlight = <&backlight_pwm>;

                // GPIO для сброса панели будет установлен из fragment@3
                // reset-gpios = <...>;

                port {
                    panel_in_dsi1: endpoint {
                        remote-endpoint = <&dsi1_out>;
                    };
                };
            };
        };
    };

    // --- Определение регуляторов питания ---
    fragment@6 {
        target-path = "/";
        __overlay__ {
            // ИЗМЕНЕНО: Отдельный регулятор для EN+5V8
            panel_power_p5v8: regulator-panel-power-p5v8 {
                compatible = "regulator-fixed";
                regulator-name = "panel_power_p5v8";
                startup-delay-us = <20000>;
                enable-active-high;
                // GPIO будет установлен из fragment@0
            };

            // ИЗМЕНЕНО: Отдельный регулятор для EN-5V8
            panel_power_n5v8: regulator-panel-power-n5v8 {
                compatible = "regulator-fixed";
                regulator-name = "panel_power_n5v8";
                startup-delay-us = <20000>;
                enable-active-high;
                // GPIO будет установлен из fragment@1
            };
        };
    };
    
    // --- Описание подсветки ---
    fragment@7 {
        target = <&pwm>;
        __overlay__ {
            #address-cells = <1>;
            #size-cells = <0>;
            status = "okay";

            backlight_pwm: backlight {
                compatible = "pwm-backlight";
                pwms = <&pwm 0 50000>; // GPIO18 (PWM0), частота 50 кГц
                // GPIO для включения будет установлен из fragment@2
                // enable-gpios = <...>;
                status = "okay";
            };
        };
    };

    // --- Описание тачскрина на шине I2C1 ---
    fragment@8 {
        target = <&i2c1>;
        __overlay__ {
            #address-cells = <1>;
            #size-cells = <0>;
            status = "okay";

            touchscreen_i2c: touchscreen@38 {
                compatible = "focaltech,ft8201";
                reg = <0x38>;
                // GPIO для прерывания и сброса будут установлены из fragment@4
            };
        };
    };

    // --- Переопределение GPIO для легкой настройки из config.txt ---
    __overrides__ {
        en_p5v8_gpio =      <&panel_power_p5v8>, "gpios:4";
        en_n5v8_gpio =      <&panel_power_n5v8>, "gpios:4";
        bl_en_gpio =        <&backlight_pwm>, "enable-gpios:4";
        panel_rst_gpio =    <&panel_dsi1>, "reset-gpios:4";
        touch_rst_gpio =    <&touchscreen_i2c>, "reset-gpios:4";
        touch_irq_gpio =    <&touchscreen_i2c>, "interrupts:0";
    };
};
